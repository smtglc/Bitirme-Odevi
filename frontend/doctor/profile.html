<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilim - Evde Sağlık</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/profile.css">
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div class="user-info">
                        <h3 id="sidebarUserName">Dr. ...</h3>
                        <p>Doktor</p>
                    </div>
                </div>
                <button onclick="window.location.href='profile.html'" class="btn btn-primary btn-block btn-sm">
                    <i class="fas fa-user"></i> Profilim
                </button>
            </div>

            <ul class="sidebar-menu">
                <li class="menu-item">
                    <a href="dashboard.html" class="menu-link">
                        <i class="fas fa-home"></i> Ana Ekran
                    </a>
                </li>
                <li class="menu-item">
                    <a href="inbox.html" class="menu-link">
                        <i class="fas fa-inbox"></i> Gelen Kutusu
                    </a>
                </li>
                <li class="menu-item">
                    <a href="appointments.html" class="menu-link">
                        <i class="fas fa-calendar-check"></i> Randevularım
                    </a>
                </li>
                <li class="menu-item">
                    <a href="services.html" class="menu-link">
                        <i class="fas fa-stethoscope"></i> Hizmetlerim
                    </a>
                </li>
                <li class="menu-item">
                    <a href="documents.html" class="menu-link">
                        <i class="fas fa-folder-open"></i> Belgelerim
                    </a>
                </li>
            </ul>

            <div class="sidebar-footer">
                <a href="#" class="menu-link" onclick="api.auth.logout()">
                    <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>Profilim</h1>
            </div>

            <!-- Profile Form -->
            <div class="card">
                <form id="profileForm" onsubmit="handleUpdateProfile(event)">
                    <h3>Kişisel Bilgiler</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">Ad *</label>
                            <input type="text" id="firstName" name="firstName" required class="form-control" readonly>
                            <small>Ad değiştirilemez</small>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Soyad *</label>
                            <input type="text" id="lastName" name="lastName" required class="form-control" readonly>
                            <small>Soyad değiştirilemez</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">E-posta *</label>
                            <input type="email" id="email" name="email" required class="form-control" readonly>
                            <small>E-posta değiştirilemez</small>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">Telefon *</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" required class="form-control"
                                readonly>
                            <small>Telefon değiştirilemez</small>
                        </div>
                    </div>

                    <h3>Mesleki Bilgiler</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="specialization">Branş *</label>
                            <input type="text" id="specialization" name="specialization" required class="form-control"
                                placeholder="Örn: Kardiyoloji, Dahiliye, Genel Cerrahi...">
                        </div>
                        <div class="form-group">
                            <label for="licenseNumber">Lisans Numarası *</label>
                            <input type="text" id="licenseNumber" name="licenseNumber" required class="form-control"
                                placeholder="Doktor lisans numaranızı girin...">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="yearsOfExperience">Deneyim (Yıl) *</label>
                        <input type="number" id="yearsOfExperience" name="yearsOfExperience" min="0" required
                            class="form-control" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label for="bio">Hakkımda / Biyografi</label>
                        <textarea id="bio" name="bio" class="form-control" rows="4"
                            placeholder="Kendiniz hakkında bilgi verin, uzmanlık alanlarınızı, çalıştığınız kurumları belirtin..."></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="loadProfile()">
                            <i class="fas fa-undo"></i> Sıfırla
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Kaydet
                        </button>
                    </div>
                </form>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="spinner" style="display: none;"></div>
        </main>
    </div>

    <script src="../js/api.js"></script>
    <script>
        if (!requireAuth(['Doctor'])) {
            window.location.href = '../index.html';
        }

        let profileData = null;

        async function loadProfile() {
            try {
                const user = api.getUser();
                document.getElementById('sidebarUserName').textContent = `Dr. ${user.firstName} ${user.lastName}`;

                document.getElementById('loadingSpinner').style.display = 'block';
                const response = await api.doctor.getProfile();
                profileData = response.data;

                // Fill form with profile data
                document.getElementById('firstName').value = profileData.firstName || '';
                document.getElementById('lastName').value = profileData.lastName || '';
                document.getElementById('email').value = profileData.email || '';
                document.getElementById('phoneNumber').value = profileData.phoneNumber || '';
                document.getElementById('specialization').value = profileData.specialization || '';
                document.getElementById('licenseNumber').value = profileData.licenseNumber || '';
                document.getElementById('yearsOfExperience').value = profileData.yearsOfExperience || 0;
                document.getElementById('bio').value = profileData.bio || '';

            } catch (error) {
                console.error('Profile load error:', error);
                showToast('Profil yüklenirken hata oluştu', 'error');
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        async function handleUpdateProfile(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const updateData = {
                specialization: formData.get('specialization'),
                licenseNumber: formData.get('licenseNumber'),
                yearsOfExperience: parseInt(formData.get('yearsOfExperience')),
                bio: formData.get('bio') || null
            };

            try {
                document.getElementById('loadingSpinner').style.display = 'block';
                const response = await api.doctor.updateProfile(updateData);

                if (response.success) {
                    showToast('Profil başarıyla güncellendi!', 'success');
                    await loadProfile();
                } else {
                    showToast(response.message || 'Profil güncellenemedi', 'error');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showToast('Bir hata oluştu: ' + error.message, 'error');
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        loadProfile();
    </script>
</body>

</html>